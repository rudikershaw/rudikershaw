<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:th="http://www.w3.org/1999/xhtml">
	<head th:replace="articles/computationalmethod :: head" />
	<body>
		<div class="header" th:replace="index :: header"></div>
		<br />
		<div class="text-container">
			<p class="date">17/11/2019</p>
			<p class="views"><span th:text="${article.views}"></span> views</p>
		</div>
		<h1 th:text="${article.name}">Git Hooks and Java Projects</h1>
		<hr />
		<img class="coverimg" src="/images/git-hooks-banner.jpg" alt="Picture of a close up section of an old fishing hook" />
		<br />

		<p>I hope that reading this piece will convince you, not just to use Git hooks, but also <strong class="bold">how and why</strong>
			we should use them in our projects. I've tried to find best practices for using git hooks in our projects, but the only place this kind of
			information can be found is in dribs and drabs scattered across <a href="https://stackoverflow.com/q/427207/2182928" target="_blank">Stackoverflow questions</a>.
			I hope that this can serve as a starting point, for a more comprehensive view on the subject.</p>
		<br />
		<h2>Why Use Git Hooks?</h2>
		<br />
		<p>One reason, is to automate something you do every time you perform a certain action in Git. For instance running a build when changes are received
			on a given branch. However, these kinds of tasks are usually solved by tools built for purpose. For example Jenkins, Travis CI, Github
			actions, etc.</p>
		<br />
		<p>My favorite reason for using hooks is as validation. Early validation provides us with quick and regular feedback (important for developing expertise
			in any field) and stops us from wasting time by straying down the wrong path.</p>
		<br />
		<p>Lets take a simple example, first without the hook. Your project has a standard commit messages format, and you've done an early commit on
			your branch wrong. Then you merge in another branch, add multiple new commits, and push. The remote repository rejects your changes. You now have
			to change that single commit message on your branch. You could do an interactive rebase, squash merge onto a new branch, or cherry-pick your commits
			onto a new branch. Either way, you have to do more work than normal.</p>
		<br />
		<p>What about with a validating hook in place to provide early feedback? Your project has a standard commit messages format, and
			you've done an early commit on your branch wrong. The commit-msg hook stops the commit, immediately flags your commit message as incorrect, and asks
			you to try again. Done. Early regular feedback stops you making work for yourself, and you learn not to make that mistake much quicker.</p>
		<br />
		<h2>Managing Your Hooks</h2>
		<br />
		<p>Let's say you're convinced and you want to add some hooks. How should we organise them? Makes sense to keep them in your project's Git repo so you can
			track changes to them. But what if you need to use them across multiple repositories? And how will you get the client side hooks installed for everyone
			working on the project?</p>
		<br />
		<p>Hooks should be managed the same way any good code should be. They should be a dependency of your project, pulled in and installed/updated when you build
			your application. Let's go through an example Java setup using Maven as our build tool. Full disclosure: I wrote one plugin and the client side
			Git hooks library used in the example that follows. So it might be worth checking to see if there is anything better suited for your needs.</p>
		<br />
		<h2>A Java &amp; Maven Example</h2>
		<br />
		<p>First we're going to need a git repository for our own hooks, or a standard library of hooks. We're not going to go into writing the hooks themselves.
			There are plenty of resources out there for that. So for our example we will use my small configurable library of
			<a href="https://github.com/rudikershaw/client-git-hooks" target="_blank">client side git hooks</a>.</p>
		<br />
		<div class="info-box">If you have your git hooks in a separate repository there is a good chance you will want your hooks to work in subtly different ways
			in each of your projects. A good way of handling this is to have your hooks take configuration from the <span class="code-inline">git config</span> of your
			local repository. You can set this config in your build differently for each project.</div>
		<br />
		<p>Next we need to store, and make available, releasable versions of our hooks. If your hooks are managed in a Maven project you could deploy them
			to a Maven repository, and get them into your project using the <a href="https://maven.apache.org/plugins/maven-dependency-plugin/" target="_blank">maven-dependency-plugin</a>.
			If your hooks library is just a collection of shell files, as in our case, then we can just make each releasable version available for download by
			URL. GitHub lets us add arbitrary compressed files to each release, and gives us an end-point you can download from.</p>
		<br />
		<p>Now we need to get a particular release of our hooks into our project. We want it to do this during our build. As we just have a URL,
			we can use the <a href="https://maven.apache.org/plugins/maven-antrun-plugin/" target="_blank">maven-antrun-plugin</a> to download and unpack our hooks.
			Here's our plugin definition from our <span class="code-inline">pom.xml</span>.</p>
		<br />
		<pre class="code">
<span class="orange">&lt;plugin&gt;</span>
  <span class="orange">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="orange">&lt;/groupId&gt;</span>
  <span class="orange">&lt;artifactId&gt;</span>maven-antrun-plugin<span class="orange">&lt;/artifactId&gt;</span>
  <span class="orange">&lt;version&gt;</span>1.8<span class="orange">&lt;/version&gt;</span>
  <span class="orange">&lt;executions&gt;</span>
    <span class="orange">&lt;execution&gt;</span>
      <span class="orange">&lt;id&gt;</span>download-hooks<span class="orange">&lt;/id&gt;</span>
      <span class="orange">&lt;phase&gt;</span>initialize<span class="orange">&lt;/phase&gt;</span>
      <span class="orange">&lt;goals&gt;</span>
        <span class="orange">&lt;goal&gt;</span>run<span class="orange">&lt;/goal&gt;</span>
      <span class="orange">&lt;/goals&gt;</span>
      <span class="orange">&lt;configuration&gt;</span>
        <span class="orange">&lt;failOnError&gt;</span>false<span class="orange">&lt;/failOnError&gt;</span>
        <span class="orange">&lt;target&gt;</span>
          <span class="orange">&lt;taskdef</span> resource=&#x22;net/sf/antcontrib/antcontrib.properties&#x22; <span class="orange">/&gt;</span>
          <span class="orange">&lt;if&gt;</span>
            <span class="orange">&lt;available</span> file=&#x22;${basedir}/etc/git-hooks/v${git.hooks.version}&#x22; <span class="orange">/&gt;</span>
            <span class="orange">&lt;else&gt;</span>
              <span class="orange">&lt;delete</span> dir=&#x22;${basedir}/etc/git-hooks/&#x22; <span class="orange">/&gt;</span>
              <span class="orange">&lt;get</span> src=&#x22;https://github.com/rudikershaw/client-git-hooks/releases/download/${git.hooks.version}/git-hooks.zip&#x22;
		   dest=&#x22;${project.build.directory}/git-hooks.zip&#x22; <span class="orange">/&gt;</span>
              <span class="orange">&lt;unzip</span> src=&#x22;${project.build.directory}/git-hooks.zip&#x22; dest=&#x22;${basedir}/etc&#x22; <span class="orange">/&gt;</span>
              <span class="orange">&lt;chmod</span> dir=&#x22;${basedir}/etc/git-hooks/&#x22; includes=&#x22;**/**&#x22; perm=&#x22;700&#x22; <span class="orange">/&gt;</span>
              <span class="orange">&lt;touch</span> file=&#x22;${basedir}/etc/git-hooks/v${git.hooks.version}&#x22; <span class="orange">/&gt;</span>
            <span class="orange">&lt;/else&gt;</span>
          <span class="orange">&lt;/if&gt;</span>
        <span class="orange">&lt;/target&gt;</span>
      <span class="orange">&lt;/configuration&gt;</span>
    <span class="orange">&lt;/execution&gt;</span>
  <span class="orange">&lt;/executions&gt;</span>
  <span class="orange">&lt;dependencies&gt;</span>
    <span class="orange">&lt;dependency&gt;</span>
      <span class="orange">&lt;groupId&gt;</span>ant-contrib<span class="orange">&lt;/groupId&gt;</span>
      <span class="orange">&lt;artifactId&gt;</span>ant-contrib<span class="orange">&lt;/artifactId&gt;</span>
      <span class="orange">&lt;version&gt;</span>20020829<span class="orange">&lt;/version&gt;</span>
    <span class="orange">&lt;/dependency&gt;</span>
  <span class="orange">&lt;/dependencies&gt;</span>
<span class="orange">&lt;/plugin&gt;</span></pre>
		<br />
		<p>With the above, we download and unzip the archive into our git hooks directory and then give the
			files the appropriate permissions to allow Git to run them. We also create a version file in the directory we move the hooks to. That way we
			can check if we have the correct version already and then skip the process if it has already been done. By checking the version like this
			it will work as you would expect if you change the <span class="code-inline">${git.hooks.version}</span> property declared at the top of our
			<span class="code-inline">pom.xml</span> (not shown).</p>
		<br />
		<p>I have chosen to put our hooks directory into the <span class="code-inline">etc/</span> directory in our project. Initially it might seem
			<span class="code-inline">target/</span> is a better place to put them, as they are effectively temporary files downloaded in the build. But
			we don't really want these files cleared away if someone runs <span class="code-inline">mvn clean</span>.</p>
		<br />
		<div class="info-box">There are four standard ways of telling git to use your hooks; move them into the <span class="code-inline">.git/hooks/</span>
			directory, symlink another directory to <span class="code-inline">.git/hooks/</span>, add <span class="code-inline">core.hooksPath</span> config,
			or use a <span class="code-inline">git init</span> template directory.</div>
		<br />
		<p>We have our hooks in our project, but we still need to tell git to use them. To do this, we are going to use a feature of git that has been
			available since version 2.9. We can tell git to use a different folder to read its hooks from by setting the git config <span class="code-inline">core.hooksPath</span> to
			our directory. But we also want to do this in our build. There shouldn't be any manual steps. Let's add another plugin to our <span class="code-inline">pom.xml</span>.</p>
		<br />
		<pre class="code">
<span class="orange">&lt;plugin&gt;</span>
  <span class="orange">&lt;groupId&gt;</span>com.rudikershaw.gitbuildhook<span class="orange">&lt;/groupId&gt;</span>
  <span class="orange">&lt;artifactId&gt;</span>git-build-hook-maven-plugin<span class="orange">&lt;/artifactId&gt;</span>
  <span class="orange">&lt;version&gt;</span>3.0.0<span class="orange">&lt;/version&gt;</span>
  <span class="orange">&lt;configuration&gt;</span>
    <span class="orange">&lt;gitConfig&gt;</span>
      <span class="orange">&lt;core.hooksPath&gt;</span>etc/git-hooks/<span class="orange">&lt;/core.hooksPath&gt;</span>
      <span class="orange">&lt;hooks.commitmsgregex&gt;</span>(\w+\s){3,}(\w+\.)<span class="orange">&lt;/hooks.commitmsgregex&gt;</span>
    <span class="orange">&lt;/gitConfig&gt;</span>
  <span class="orange">&lt;/configuration&gt;</span>
  <span class="orange">&lt;executions&gt;</span>
    <span class="orange">&lt;execution&gt;</span>
      <span class="orange">&lt;goals&gt;</span>
        <span class="orange">&lt;goal&gt;</span>initialize<span class="orange">&lt;/goal&gt;</span>
        <span class="orange">&lt;goal&gt;</span>configure<span class="orange">&lt;/goal&gt;</span>
      <span class="orange">&lt;/goals&gt;</span>
    <span class="orange">&lt;/execution&gt;</span>
  <span class="orange">&lt;/executions&gt;</span>
<span class="orange">&lt;/plugin&gt;</span></pre>
		<br />
		<p>This is the <a href="https://github.com/rudikershaw/git-build-hook" target="_blank">git-build-hook-maven-plugin</a> (my precious).
			It is designed to manage your developer's local git from your build, and have changes applied when the build is run. In this
			case we are initializing a git repo if one does not already exist, setting the <span class="code-inline">core.hooksPath</span>
			config to point to our git hooks folder, and setting some custom git config (<span class="code-inline">hooks.commitmsgregex</span>)
			to set a regex to use to validate our commit messages.</p>
		<br />
		<p>Once we run the build with these plugins, our hooks should be ready to go. So let's try and commit the changes with a commit message
			that our regex wouldn't match.</p>
		<br />
		<pre class="code">
<span class="green">rudi@XPS</span>:<span class="jade">~/projects/rudikershaw.com$</span> git add .
<span class="green">rudi@XPS</span>:<span class="jade">~/projects/rudikershaw.com$</span> git commit -m "wat"
Commit message does not adhere to '(\w+\s){3,}(\w+\.)', try again.
<span class="green">rudi@XPS</span>:<span class="jade">~/projects/rudikershaw.com$</span></pre>
		<br />
		<h2>To Summarise</h2>
		<br />
		<p>It seems strange that where-ever we find explanations or tutorials online on git hooks, they never mention how we should manage the
			development and maintenance of these hooks. They rarely even mention how to get them out to everyone. The
			<a href="https://www.atlassian.com/git/tutorials/git-hooks" target="_blank">Atlassian documentation</a> on git hooks even goes so
			far as to say that some of the things explained in this article can't be done. It's time we start thinking about using industry
			best practices when creating and maintaining our hooks.</p>
		<br />
		<p>Thank you for reading my thoughts on how we should be using git hooks (local git hooks in particular). If you have any feedback,
			questions, or Gods forbid praise, feel free to leave my a comment below.</p>

		<br />
		<br />
		<hr />

		<div class="article-footer" th:replace="articles/computationalmethod :: article-footer"></div>

		<div class="text-container"><div id="disqus_thread"></div></div>
		<script type="text/javascript">
			/* * * Configure Disqus Variables * * */
			var disqus_shortname = 'codenerd';
			var disqus_identifier = '1 - Git Hooks and Java Projects';
			var disqus_title = 'Git Hooks and Java Projects';

			/* * * Declare disqus display script * * */
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

	</body>
</html>
